let total_loop=1,translationInProgress=!1,progressDoneCalled=!1,proBtn='<span class="wpm-upgrade-to-pro-note" style="margin-left: 50px; font-weight: 500;"> This Feature requires the <a href="https://wp-multilang.com/pricing/#pricings" target="__blank">Premium Version</span>',openAINote='<span class="wpm-upgrade-to-pro-note" style="margin-left: 50px; font-weight: 500;"> Please configure OpenAI settings</span>',licenseKeyError='<span class="wpm-upgrade-to-pro-note" style="margin-left: 50px; font-weight: 500;"> Your license key is inactive or expired</span>';jQuery(document).ready(function(e){function t(){if(void 0===e.fn.select2){console.warn("Select2 not loaded yet, retrying in 100ms..."),setTimeout(t,100);return}e(".exclude-select").each(function(){let t=e(this),s=t.data("type");if(!t.hasClass("select2-hidden-accessible"))try{t.select2({placeholder:"Search items to exclude...",minimumInputLength:2,width:"100%",dropdownParent:t.parent(),ajax:{url:wpmpro_autotranslate_localize_data.ajax_url,dataType:"json",delay:250,data:function(e){let t={action:"wpmpro_search_items",search:e.term,type:s,_wpnonce:wpmpro_autotranslate_localize_data.nonce};return console.log("Select2 AJAX request data:",t),t},processResults:function(e){return(console.log("Select2 AJAX response:",e),e&&e.success&&e.data)?{results:e.data||[]}:Array.isArray(e)?{results:e}:e&&e.data?{results:e.data}:(console.warn("Unexpected response format:",e),{results:[]})},cache:!0,error:function(e,t,s){console.error("Select2 AJAX error:",{xhr:e,status:t,error:s})}}})}catch(r){console.error("Select2 initialization error:",r)}})}async function s(t,s,a,o,n,l){let i=0,p=0,c=0,g=0,u=0,d=[];for(let m of(console.log(`üöÄ Starting translation for post type: ${s} with ${a} items`),t)){console.log(`üåê Starting translation for language: ${m}`);for(let $=1;$<=a;$++){console.log(`üìÑ Processing page ${$} of ${a} for language ${m}`);try{let f=await r($,m,s,a,n);i++,l(1),f&&"object"==typeof f?!0===f.success?(p++,console.log(`‚úì Success: page ${$}, language ${m} - ${f.message||"No message"}`)):(c++,f.error&&f.error.includes&&f.error.includes("timeout")&&g++,!0===f.retryable&&u++,console.warn(`‚úó Failed: page ${$}, language ${m} - ${f.error||"Unknown error"}`),d.push({page:$,lang:m,post_type:s,error:f.error||"Unknown error",retryable:!0===f.retryable})):(console.warn(`‚ö†Ô∏è Invalid result for page ${$}, language ${m} - treating as success`),p++);let h=Math.round(i/o*100),w=`Translating: ${s} in ${m} (${i}/${o}) (${h}%) - Success: ${p}, Errors: ${c}, Timeouts: ${g}`;e("#wpmpro-progress_count").html(w),await new Promise(e=>setTimeout(e,300))}catch(y){c++,i++,l(1),console.error(`‚úó Exception processing page ${$}, language ${m}:`,y),d.push({page:$,lang:m,post_type:s,error:y.message||"Exception occurred",retryable:!0});let x=Math.round(i/o*100),_=`Translating: ${s} in ${m} (${i}/${o}) (${x}%) - Success: ${p}, Errors: ${c}, Exceptions: ${c-p}`;e("#wpmpro-progress_count").html(_)}}console.log(`‚úÖ Completed language ${m} for post type ${s}`)}console.log(`üéØ Translation completed for ${s}. Processed: ${i}, Success: ${p}, Errors: ${c}, Timeouts: ${g}, Retries: ${u}`);let T=`Completed: ${s} - Success: ${p}, Errors: ${c}, Timeouts: ${g}`;return console.log(T),{processed:i,success:p,errors:c,timeouts:g,retries:u,failed_items:d}}function r(t,s,a,o,n,l=0){return new Promise(i=>{if(t>o){i({success:!1,error:"Page out of range"});return}let p=3e4+15e3*l;console.log(`Processing page ${t} (attempt ${l+1}/3) with timeout ${p}ms`),e.ajax({type:"POST",url:wpmpro_autotranslate_localize_data.ajax_url,data:{action:"wpm_do_auto_translate",post_type:a,offset:t,source:wpmpro_autotranslate_localize_data.source_language,excluded_items:JSON.stringify(n),target:s,wpmpro_autotranslate_nonce:wpmpro_autotranslate_localize_data.wpmpro_autotranslate_nonce},headers:{"Content-Type":"application/x-www-form-urlencoded"},dataType:"json",timeout:p,success:function(e){if(console.log("Translation response for page",t,":",e),!e||null==e){console.warn("Empty response for page",t,"- treating as success to continue"),i({success:!0,message:"Empty response - continuing"});return}"object"==typeof e&&null!==e?!0===e.status||!0===e.success?(console.log("‚úì Translation successful for page",t,"-",e.message||"No message"),i({success:!0,message:e.message||"Translation completed"})):(console.warn("‚úó Translation failed for page",t,":",e.message||"Unknown error"),i({success:!0,message:"Failed but continuing - "+(e.message||"Unknown error")})):(console.warn("Unexpected response format for page",t,":",e,"- treating as success"),i({success:!0,message:"Unexpected response format - continuing"}))},error:function(e,p,c){let g="timeout"===p,u="abort"===p;console.error("AJAX error for page",t,":",{status:p,error:c,isTimeout:g,isAbort:u,responseText:e.responseText?e.responseText.substring(0,200):"No response",readyState:e.readyState,statusText:e.statusText});let d=null;try{if(e.responseText&&""!==e.responseText.trim()&&(d=JSON.parse(e.responseText))&&!0===d.status){console.log("‚úì Translation successful despite error status"),i({success:!0,message:"Translation completed despite error"});return}}catch(m){console.warn("Could not parse error response as JSON:",m.message)}let $=l<2&&(g||e.status>=500&&e.status<600);if($)console.log(`üîÑ Retrying page ${t} in 2 seconds... (attempt ${l+2})`),setTimeout(()=>{r(t,s,a,o,n,l+1).then(i)},2e3);else{let f=g?"Request timeout":u?"Request aborted":`HTTP ${e.status}: ${e.statusText}`;console.warn(`‚ö†Ô∏è Final failure for page ${t}: ${f} - continuing to next page`),i({success:!0,message:`Failed: ${f} but continuing`})}}})})}function a(e){if(!Number.isInteger(e))return null;let t=t=>{let s=Math.trunc(e/t);return e-=s*t,s};return{hours:t(36e5),minutes:t(6e4),seconds:t(1e3),ms:e}}function o(e){let t=e.hours,s=e.minutes,r=e.seconds,a=e.ms,o="";return t>0&&(o=t+" hour(s) "),s>0&&(o+=s+" minute(s) "),0==s&&(o=""),(0==s||r>0||a>0)&&(o=" Less than a minute"),o+=" remaing..."}async function n(t){let s=!0;if(!wpmpro_autotranslate_localize_data.is_pro_active&&"openai"===t&&wpmpro_autotranslate_localize_data.ai_settings.model.length>0&&"1"==wpmpro_autotranslate_localize_data.ai_settings.wpm_openai_integration){e("#wpmpro-translate").hide(),e("#wpmpro-translate-hide").show();try{var r;let a=await (r=t,new Promise(function(e,t){jQuery.ajax({type:"POST",url:wpmpro_autotranslate_localize_data.ajax_url,data:{action:"wpm_check_ai_platform_quota",provider:r,wpmpro_autotranslate_nonce:wpmpro_autotranslate_localize_data.wpmpro_autotranslate_nonce},success:function(t){e(t)},error:function(e){t(e)}})}));!1===a.status&&(e("#wpmpro-translation-error-message").show(),e("#wpm-ai-translate-error").text("AI Translation Error: "+a.message),e("#wpmpro-translate").show(),e("#wpmpro-translate-hide").hide(),s=!1)}catch(o){console.error("Quota check failed:",o),s=!1}}return s}e("#wpmpro-what-all-opt").change(()=>{let t=wpmpro_autotranslate_localize_data.ai_settings.api_provider,s=document.querySelectorAll(".wpmpro-what-list");if(e("#wpmpro-what-all-opt").is(":checked"))for(let r=0;r<s.length;r++){let a=s[r];if(a.checked=!0,wpmpro_autotranslate_localize_data.is_pro_active&&"active"===wpmpro_autotranslate_localize_data.license_status||"openai"===t&&wpmpro_autotranslate_localize_data.ai_settings.model.length>0){let o=e(a).closest("li").find(".exclude-wrapper");o.length>0&&o.show()}}else for(let n=0;n<s.length;n++){let l=s[n];l.checked=!1;let i=e(l).closest("li").find(".exclude-wrapper");i.length>0&&i.hide(),e(".wpmpro-what-list").each(function(){e(this).next("label").next("span.wpm-upgrade-to-pro-note").remove()})}}),e(document).on("change",".wpmpro-what-list",function(){let t=0,s=0,r=wpmpro_autotranslate_localize_data.ai_settings.api_provider,a=e(this).closest("li").find(".exclude-wrapper");e(this).is(":checked")?(wpmpro_autotranslate_localize_data.is_pro_active&&"active"===wpmpro_autotranslate_localize_data.license_status||"openai"===r&&wpmpro_autotranslate_localize_data.ai_settings.model.length>0)&&a.show():(e("label[for='"+e(this).attr("id")+"']").next("span.wpm-upgrade-to-pro-note").remove(),a.hide()),e(".wpmpro-what-list").each(function(e){t+=1}),e(".wpmpro-what-list:checked").each(function(e){s+=1}),t==s?document.getElementById("wpmpro-what-all-opt")&&(document.getElementById("wpmpro-what-all-opt").checked=!0):document.getElementById("wpmpro-what-all-opt")&&(document.getElementById("wpmpro-what-all-opt").checked=!1)}),void 0!==e.fn.select2?t():e(window).on("load",function(){setTimeout(t,100)}),e("#wpmpro-translate").on("click",async function(){e("#wpmpro-translation-error-message").hide();let t=[],a=wpmpro_autotranslate_localize_data.ai_settings.api_provider;e(".wpmpro-language-cb").each(function(){e(this).is(":checked")&&t.push(e(this).val())});let o=[],l={};if(e(".wpmpro-what-list").each(function(){if(e(this).is(":checked")){let t=e(this).val();o.push(t);let s=e(this).closest("li").find(".exclude-select");if(s.length>0){let r=s.val();r&&r.length&&(l[t]=r)}let a=e(this).closest("li").find(".exclude-select").val();a&&a.length&&(l[t]=a)}}),0===t.length)return alert("Please select language to translate"),!1;if(0===o.length)return alert("Please select what you want to translate"),!1;if(console.log("wpm_openai_integration ",wpmpro_autotranslate_localize_data.ai_settings.wpm_openai_integration),!wpmpro_autotranslate_localize_data.is_pro_active&&(0===wpmpro_autotranslate_localize_data.ai_settings.wpm_openai_integration.length||"0"==wpmpro_autotranslate_localize_data.ai_settings.wpm_openai_integration)||!wpmpro_autotranslate_localize_data.is_pro_active&&(0===a.length||0===wpmpro_autotranslate_localize_data.ai_settings.model.length)||wpmpro_autotranslate_localize_data.is_pro_active&&"active"!==wpmpro_autotranslate_localize_data.license_status)return!1;if(translationInProgress)return console.warn("‚ö†Ô∏è Translation already in progress - ignoring request"),!1;let i=await n(a);if(!i)return!1;translationInProgress=!0,progressDoneCalled=!1,console.log("\uD83D\uDE80 Starting translation process..."),e("#wpmpro-parent-progress-bar").css({display:"block"}),e("#wpmpro-translate").css({display:"none"}),e("#wpmpro-translate-hide").css({display:"block"});let p={post:wpmpro_autotranslate_localize_data.published_post_count,page:wpmpro_autotranslate_localize_data.total_pages,product:wpmpro_autotranslate_localize_data.total_product,category:wpmpro_autotranslate_localize_data.total_categories,post_tag:wpmpro_autotranslate_localize_data.total_tags,product_cat:wpmpro_autotranslate_localize_data.total_product_categories},c=0,g=0;for(let u of o){let d=p[u]||0;c+=d*t.length}let m=[],$=0,f=0,h=0;for(let w of o){let y=p[w]||0;if(console.log("total_count ",y),y>0){console.log(`üîÑ Starting translation for post type: ${w} (${y} items)`);let x=await s(t,w,y,c,l,s=>{g+=s;let r=Math.round(g/c*100);e("#wpmpro-child-progress-bar").css({width:r+"%"});let a=`Translating: ${w} in ${t.join(",")} (${g} / ${c}) (${r}%)`;e("#wpmpro-progress_count").html(a),e("#wpmpro-translate-hide").html(`Translating (${r}%)`)});$+=x.success,f+=x.errors,h+=x.processed,m=m.concat(x.failed_items||[]),console.log(`‚úÖ Completed translation for post type: ${w}`)}}if(m.length>0){console.log(`üîÑ Retrying ${m.length} failed items...`),e("#wpmpro-progress_count").html(`Retrying ${m.length} failed items...`);let _=0,T=0;for(let b of m)if(b.retryable){console.log(`üîÑ Retrying page ${b.page}, language ${b.lang} for ${b.post_type}`);try{let v=await r(b.page,b.lang,b.post_type,p[b.post_type]||0,l,0);v&&!0===v.success?(_++,console.log(`‚úì Retry successful: page ${b.page}, language ${b.lang}`)):(T++,console.warn(`‚úó Retry failed: page ${b.page}, language ${b.lang} - ${v?.error||"Unknown error"}`))}catch(k){T++,console.error(`‚úó Retry exception: page ${b.page}, language ${b.lang}`,k)}await new Promise(e=>setTimeout(e,500))}$+=_,f=f-_+T,console.log(`üéØ Retry completed: ${_} successful, ${T} still failed`)}console.log("\uD83C\uDF89 All post types completed - calling progressDone()"),function t(s=0,r=0,a=0){if(progressDoneCalled){console.warn("‚ö†Ô∏è progressDone() already called - ignoring duplicate call");return}progressDoneCalled=!0,translationInProgress=!1,console.log("\uD83C\uDFC1 progressDone() called - finalizing translation process"),e("#wpmpro-child-progress-bar").css({width:"100%"}),e("#wpmpro-progress_count").html("Translation completed (100%)"),e("#wpmpro-translate").css({display:"block"}),e("#wpmpro-translate-hide").css({display:"none"}),e("#wpmpro-translate-hide").html("Translating (0%)"),e("#wpmpro-parent-progress-bar").css({display:"none"});let o="d4edda",n="c3e6cb",l="155724",i="‚úì Translation Process Completed";r>0&&(o=r>s?"f8d7da":"fff3cd",n=r>s?"f5c6cb":"ffeaa7",l=r>s?"721c24":"856404",i=r>s?"‚ö†Ô∏è Translation Process Completed with Errors":"‚úì Translation Process Completed with Some Issues");let p=`
            <div style="background: #${o}; border: 1px solid #${n}; color: #${l}; padding: 15px; border-radius: 4px; margin: 10px 0;">
                <h4 style="margin: 0 0 10px 0; color: #${l};">${i}</h4>
                <div style="margin: 10px 0;">
                    <p style="margin: 5px 0; font-weight: bold;">üìä Final Statistics:</p>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li>‚úÖ Successfully translated: <strong>${s}</strong> items</li>
                        <li>‚ùå Failed translations: <strong>${r}</strong> items</li>
                        <li>üìù Total processed: <strong>${a}</strong> items</li>
                    </ul>
                </div>
                <p style="margin: 5px 0; font-size: 12px; color: #6c757d;">
                    ${r>0?"Some translations failed. Check the browser console for detailed error information.":"All translations completed successfully!"}
                </p>
                <p style="margin: 5px 0; font-size: 12px; color: #6c757d;">
                    You can close this message or refresh the page to see updated content.
                </p>
            </div>
        `;e("#wpmpro-translation-success-message").html(p),e("#wpmpro-translation-success-message").css({display:"block"}),console.log("\uD83C\uDF89 Translation process completed!"),console.log(`üìä Final Results: ${s} successful, ${r} failed, ${a} total processed`),r>0?console.warn(`‚ö†Ô∏è ${r} translations failed. Check the detailed logs above for error information.`):console.log("‚úÖ All translations completed successfully!")}($,f,h)})});