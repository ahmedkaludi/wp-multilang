jQuery(document).ready(function(t){function e(e,a){a.text("Translating..."),t.ajax({type:"POST",url:ajaxurl,data:{action:"wpm_singlular_auto_translate",post_id:e,source:wpmpro_ats_localize_data.source_language,target:wpmpro_ats_localize_data.target_language,wpmpro_autotranslate_singular_nonce:wpmpro_ats_localize_data.wpmpro_autotranslate_singular_nonce},headers:{"Content-Type":"application/x-www-form-urlencoded"},dataType:"json",timeout:6e5,success:function(t){console.log("Single translation response:",t),a.prop("disabled",!1).text("Auto translate"),t&&t.status?alert(t.message||"Translation completed successfully"):alert("Translation is taking time it will continue in background, please check the page in a few minutes."),location.reload()},error:function(t,e,n){console.error("Single translation AJAX Error:",{xhr:t,status:e,error:n}),a.prop("disabled",!1).text("Auto translate"),"timeout"===e?alert("Translation request timed out after 10 minutes. The translation may still be processing in the background. Please check the page in a few minutes."):404===t.status?alert("Translation is taking time it will continue in background, please check the page in a few minutes."):500===t.status?alert("Server error (500). Please check the server logs."):alert("Translation failed: "+(t.responseText||n||"Unknown error"))}})}t(document).on("click","#wpm-auto-translate-btn",function(a){if(!wpmpro_autotranslate_localize_data.is_pro_active&&"multilang"===wpmpro_autotranslate_localize_data.ai_settings.api_provider||"active"!==wpmpro_autotranslate_localize_data.license_status&&("multilang"===wpmpro_autotranslate_localize_data.ai_settings.api_provider||0===wpmpro_autotranslate_localize_data.ai_settings.api_provider.length)||"multilang"!==wpmpro_autotranslate_localize_data.ai_settings.api_provider&&0===wpmpro_autotranslate_localize_data.ai_settings.model.length||!confirm(wpmpro_ats_localize_data.confirmation_message))return!1;let n=t("#wpm-current-post-id").val(),o=t(this);o.prop("disabled",!0).text("Analyzing content..."),t.ajax({type:"POST",url:ajaxurl,data:{action:"wpm_get_translation_node_count",post_id:n,source:wpmpro_ats_localize_data.source_language,target:wpmpro_ats_localize_data.target_language,wpmpro_autotranslate_singular_nonce:wpmpro_ats_localize_data.wpmpro_autotranslate_singular_nonce},headers:{"Content-Type":"application/x-www-form-urlencoded"},dataType:"json",timeout:3e4,success:function(a){if(console.log("Node count response:",a),a&&a.success&&a.data&&a.data.total_nodes){let s=a.data.total_nodes;console.log(`Found ${s} text nodes to translate`),s<=150?(console.log("Content has 150 or fewer nodes, using single translation"),e(n,o)):(console.log(`Content has ${s} nodes, using batch processing`),function e(a,n,o){let s=Math.ceil(n/100),r=0,i=0;console.log(`Starting batch translation: ${s} batches of 100 nodes each`),!function e(){if(r>=s){console.log("All batches completed successfully"),o.prop("disabled",!1).text("Auto translate"),alert(`Translation completed successfully! Processed ${n} text nodes in ${s} batches.`),location.reload();return}let l=100*r,c=Math.round(i/s*100);o.text(`Translating batch ${r+1}/${s} (${c}%)`),console.log(`Processing batch ${r+1}/${s}: nodes ${l}-${Math.min(l+100-1,n-1)}`),t.ajax({type:"POST",url:ajaxurl,data:{action:"wpm_process_batch_translation",post_id:a,source:wpmpro_ats_localize_data.source_language,target:wpmpro_ats_localize_data.target_language,batch_start:l,batch_size:100,wpmpro_autotranslate_singular_nonce:wpmpro_ats_localize_data.wpmpro_autotranslate_singular_nonce},headers:{"Content-Type":"application/x-www-form-urlencoded"},dataType:"json",timeout:12e4,success:function(t){console.log(`Batch ${r+1} response:`,t),i++,r++,t&&t.status?(console.log(`Batch ${r} completed successfully`),setTimeout(e,1e3)):(console.warn(`Batch ${r} failed:`,t.message||"Unknown error"),r++,setTimeout(e,2e3))},error:function(t,a,n){console.error(`Batch ${r+1} AJAX Error:`,{xhr:t,status:a,error:n}),i++,r++,"timeout"===a?console.warn(`Batch ${r} timed out, continuing with next batch`):console.warn(`Batch ${r} failed with error: ${n}, continuing with next batch`),setTimeout(e,2e3)}})}()}(n,s,o))}else console.warn("Could not determine node count, falling back to single translation"),e(n,o)},error:function(t,a,s){console.error("Node count AJAX Error:",{xhr:t,status:a,error:s}),console.warn("Could not get node count, falling back to single translation"),e(n,o)}})}),t(document).on("click","#wpm-auto-translate-term-btn",function(e){if("active"!==wpmpro_ats_localize_data.license_status||!confirm(wpmpro_ats_localize_data.confirmation_message))return!1;t(this).addClass("update-message"),t.ajax({type:"POST",url:ajaxurl,data:{action:"wpm_singlular_auto_translate_term",tag_id:wpmpro_ats_localize_data.tag_id,source:wpmpro_ats_localize_data.source_language,target:wpmpro_ats_localize_data.target_language,wpmpro_autotranslate_singular_nonce:wpmpro_ats_localize_data.wpmpro_autotranslate_singular_nonce},headers:{"Content-Type":"application/x-www-form-urlencoded"},dataType:"json",success:function(t){t.status,alert(t.message),location.reload()},error:function(t){alert(t.message)}})})});